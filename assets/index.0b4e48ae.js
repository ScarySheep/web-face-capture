import{S as e,C as t,P as n,W as o,A as a,s as i,F as s,D as r,G as l,f as c,E as d,N as u,Q as h,a as p,b as m,c as g}from"./vendor.b7c543e3.js";let f,w,y,b,E,x,v,I,B=!1,R=[],S=document.querySelector("#videoElement");const L=document.createElement("a");function j(e,t){L.href=URL.createObjectURL(e),L.download=t,L.click()}L.style.display="none",document.body.appendChild(L),navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then((function(e){S.srcObject=e})).catch((function(e){console.log("Something went wrong!")})),function(){w=new m,f=document.querySelector("#bg");const c=new e;c.background=new t(16777215);const d=new n(45,4/3,.1,100);d.position.set(0,0,50);const S=new o({canvas:f,antialias:!0});S.setPixelRatio(window.devicePixelRatio),S.setSize(f.clientWidth,f.clientWidth/4*3),S.toneMapping=a,S.outputEncoding=i,(new s).load("face.fbx",(e=>{b=e,y=e.getObjectByName("head"),E=e.getObjectByName("eyeLeft"),x=e.getObjectByName("eyeRight");for(let t=0;t<52;t++)y.morphTargetDictionary[t]=t;v=y.morphTargetDictionary,I=y.morphTargetInfluences,c.add(e)}),(e=>{}),(e=>{console.log(e)}));const L=new r(16777215);L.position.set(0,200,100),L.castShadow=!0,c.add(L),S.setAnimationLoop((()=>{S.render(c,d)})),window.addEventListener("resize",(()=>{d.aspect=f.clientWidth/f.clientHeight,d.updateProjectionMatrix(),S.setSize(f.clientWidth,f.clientWidth/4*3)})),document.getElementById("download").addEventListener("click",(()=>{let e={binary:!0,animations:[function(){if(0!=R.length){let e=[];for(let u=0;u<52;u++)e.push([]);let t=[],n=[],o=0,a=0;R.forEach(((i,s)=>{if(0==s)o=i.time,Object.entries(i.blendshapes).forEach((([t,n])=>{e[v[t]].push(n)})),t.push(i.rotation),n.push(a/30),a++;else for(;i.time>a/30+o;){let r=a/30+o-R[s-1].time,l=i.time-(a/30+o);Object.entries(i.blendshapes).forEach((([t,n])=>{let o=n,a=R[s-1].blendshapes[t];e[v[t]].push((a*l+o*r)/(r+l))}));let c=new g;c.slerpQuaternions(R[s-1].rotation,i.rotation,r/(r+l)),t.push(c),n.push(a/30),a++}}));let i=[];Object.entries(R[0].blendshapes).forEach((([t,o])=>{let a=v[t],s=new u(`head.morphTargetInfluences[${a}]`,n,e[a]);i.push(s)}));let s=[],r=[];t.forEach((e=>{s.push(e.x),s.push(e.y),s.push(e.z),s.push(e.w);let t=e.clone();t.invert(),r.push(t.x),r.push(t.y),r.push(t.z),r.push(t.w)}));let l=new h("grp_scale.quaternion",n,s);i.push(l);let c=new h("eyeLeft.quaternion",n,r),d=new h("eyeRight.quaternion",n,r);i.push(c),i.push(d);return new p("animation",-1,i)}return null}()]};(new l).parse(b,(function(e){if(e instanceof ArrayBuffer)t="scene.glb",j(new Blob([e],{type:"application/octet-stream"}),t);else{!function(e,t){j(new Blob([e],{type:"text/plain"}),t)}(JSON.stringify(e,null,2),"scene.gltf")}var t}),e)})),document.getElementById("record").addEventListener("click",(()=>{B?(document.getElementById("record").innerText="Record",B=!1,document.getElementById("download").classList.remove("hidden")):(R=[],document.getElementById("record").innerText="Stop",B=!0,document.getElementById("download").classList.add("hidden"))})),document.getElementById("download").classList.add("hidden")}(),function(){const e=new c.exports.ApplicationContext(window.location.href),t=new c.exports.ResourceFileSystem(e);c.exports.FacemojiAPI.initialize("dfe3er64ijyqmqtqg2nt6btjuus754busbnboca7ef553iw32qyf27i",e).then((e=>{e?console.info("API successfully activated"):console.info("API could not be activated")}));const n=c.exports.FaceTracker.createVideoTracker(t).then((e=>(requestAnimationFrame(o),e))).logError("Could not start tracking");function o(){requestAnimationFrame(o);var e=n.currentValue;if(!e||null===S)return;var t=e.track(S);if(null==t)return;let a={},i=0,s=0;const r=(l=t.rotationQuaternion,c=l.toEuler(),u=.5*Math.PI,[["headLeft",Math.max(0,c.y)/u],["headRight",-Math.min(0,c.y)/u],["headUp",-Math.min(0,c.x)/u],["headDown",Math.max(0,c.x)/u],["headRollLeft",-Math.min(0,c.z)/u],["headRollRight",Math.max(0,c.z)/u]]);var l,c,u;b.setRotationFromEuler(new d(r[3][1]-r[2][1],r[0][1]-r[1][1],r[5][1]-r[4][1],"XYZ")),E.setRotationFromEuler(new d(-r[3][1]+r[2][1],-r[0][1]+r[1][1],-r[5][1]+r[4][1],"XYZ")),x.setRotationFromEuler(new d(-r[3][1]+r[2][1],-r[0][1]+r[1][1],-r[5][1]+r[4][1],"XYZ"));for(const[n,o]of t.blendshapes)"browInnerUp_R"==n&&(i=o),"browInnerUp_L"==n&&(s=o),null!=v[n]&&(I[v[n]]=o,B&&(a[n]=o));if(I[v.browInnerUp]=(i+s)/2,B&&(a.browInnerUp=(i+s)/2),B){let e=w.getElapsedTime(),t=new d(r[3][1]-r[2][1],r[0][1]-r[1][1],r[5][1]-r[4][1],"XYZ"),n=new g;n.setFromEuler(t);let o={time:e,blendshapes:a,rotation:n};R.push(o)}let h=document.getElementById("rectangle");if(null!==h){const e=t.faceRectangle.flipY(t.inputImageSize.y).normalizeBy(t.inputImageSize).scale(S.clientWidth,S.clientHeight).scaleAroundCenter(.8,.8);h.style.position="relative",h.style.left=e.x.toString()+"px",h.style.top=e.y.toString()+"px",h.style.width=e.width.toString()+"px",h.style.height=e.height.toString()+"px",p=t.hasFace(),null!==document.getElementById("rectangle")&&(document.getElementById("rectangle").style.display=p?"block":"none")}var p}}();
